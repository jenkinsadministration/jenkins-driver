<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.32">
    <actions/>
    <description></description>
    <keepDependencies>false</keepDependencies>
    <properties>
        {% if log_rotate > 0 %}
            <jenkins.model.BuildDiscarderProperty>
                <strategy class="hudson.tasks.LogRotator">
                    <daysToKeep>-1</daysToKeep>
                    <numToKeep>{{log_rotate}}</numToKeep>
                    <artifactDaysToKeep>-1</artifactDaysToKeep>
                    <artifactNumToKeep>-1</artifactNumToKeep>
                </strategy>
            </jenkins.model.BuildDiscarderProperty>
        {% endif %}
        <org.jenkinsci.plugins.workflow.job.properties.DisableConcurrentBuildsJobProperty/>
        <hudson.model.ParametersDefinitionProperty>
             <parameterDefinitions>
                 {% if branch == "" %}
                    <hudson.model.StringParameterDefinition>
                        <name>Branch</name>
                        <description></description>
                        <defaultValue>dev</defaultValue>
                        <trim>false</trim>
                    </hudson.model.StringParameterDefinition>
                 {% endif %}
                     <hudson.model.ChoiceParameterDefinition>
                         <name>Lane</name>
                         <description></description>
                         <choices class="java.util.Arrays$ArrayList">
                             <a class="string-array">
                                 {% for value in ['DemoRC', 'Night', 'Release', 'Demo Night']%}
                                 <string>{{value}}</string>
                                 {% endfor %}
                             </a>
                         </choices>
                     </hudson.model.ChoiceParameterDefinition>
                 {% for p in parameters %}
                    {% if p['is_parameterizable'] %}
                        {% if p['type'] == 'string' %}
                            <hudson.model.StringParameterDefinition>
                                <name>{{p['name']}}</name>
                                <description>{{p['description']}}</description>
                                <defaultValue>{{p['default_value']}}</defaultValue>
                                <trim>false</trim>
                            </hudson.model.StringParameterDefinition>
                        {% endif %}
                        {% if p['type'] == 'boolean'  %}
                            <hudson.model.BooleanParameterDefinition>
                                <name>{{p['name']}}</name>
                                <description>{{p['description']}}</description>
                                <defaultValue>{{p['default_value']}}</defaultValue>
                            </hudson.model.BooleanParameterDefinition>
                        {% endif %}
                        {% if p['type'] == 'choice' %}
                            <hudson.model.ChoiceParameterDefinition>
                                <name>{{p['name']}}</name>
                                <description>{{p['description']}}</description>
                                <choices class="java.util.Arrays$ArrayList">
                                    <a class="string-array">
                                        {% for value in p['values'] %}
                                            <string>{{value}}</string>
                                        {% endfor %}
                                    </a>
                                </choices>
                            </hudson.model.ChoiceParameterDefinition>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </parameterDefinitions>
        </hudson.model.ParametersDefinitionProperty>
        {% if cron['poll_scm'] != '' %}
            <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
              <triggers>
                    <hudson.triggers.SCMTrigger>
                        <spec>{{cron['poll_scm']}}</spec>
                    </hudson.triggers.SCMTrigger>
              </triggers>
            </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
        {% endif %}
    </properties>
    {% if cron['build'] != '' %}
        <triggers>
            <hudson.triggers.TimerTrigger>
                <spec>{{cron['build']}}</spec>
            </hudson.triggers.TimerTrigger>
        </triggers>
    {% endif %}
    <concurrentBuild>false</concurrentBuild>
    <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.65">
        <script>
import hudson.model.*
import hudson.model.AbstractProject
import hudson.tasks.Mailer


BUILD_JOB_NAME = "${JOB_NAME}"

pipeline {
    agent { node { label '{{label}}' } }
    stages {
        stage('Preparation') {
            steps {
                script {
                    currentBuild.displayName = "Build_" + "${BUILD_TIMESTAMP}"
                }
                checkout([$class: 'GitSCM',
                    branches: [[name: "${params.Branch}"]],
                    extensions: [[$class: 'CloneOption', timeout: 120]],
                    gitTool: 'Default',
                    userRemoteConfigs: [[url: '{{repository}}']]
                ])
            }
        }
        stage('Unlock Keychain') {
            steps {
                sh "security unlock-keychain -p Automation01 ~/Library/Keychains/login.keychain"
            }
        }
        stage('Install Pods') {
            steps {
                sh "rm Podfile.lock"
                sh "export LANG=en_US.UTF-8 &amp;&amp; /usr/local/bin/pod repo update"
                sh "export LANG=en_US.UTF-8 &amp;&amp; /usr/local/bin/pod install"
            }
        }
        stage ('Build Demo Release Candidate') {
            when {
                expression { params.Lane == 'DemoRC' }
            }
            steps {
                sh "export LANG=en_US.UTF-8 &amp;&amp; export FASTLANE_XCODE_LIST_TIMEOUT=120 &amp;&amp; export FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT=120 &amp;&amp; export FASTLANE_XCODEBUILD_SETTINGS_RETRIES=13 &amp;&amp; /usr/local/bin/fastlane demoRC"
            }
        }
        stage ('Build Night') {
            when {
                expression { params.Lane == 'Night' }
            }
            steps {
                sh "export LANG=en_US.UTF-8 &amp;&amp; export FASTLANE_XCODE_LIST_TIMEOUT=120 &amp;&amp; export FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT=120 &amp;&amp; export FASTLANE_XCODEBUILD_SETTINGS_RETRIES=13 &amp;&amp; /usr/local/bin/fastlane night"
            }
        }
        stage ('Build Release') {
            when {
                expression { params.Lane == 'Release' }
            }
            steps {
                sh "export LANG=en_US.UTF-8 &amp;&amp; export FASTLANE_XCODE_LIST_TIMEOUT=120 &amp;&amp; export FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT=120 &amp;&amp; export FASTLANE_XCODEBUILD_SETTINGS_RETRIES=13 &amp;&amp; /usr/local/bin/fastlane release"
            }
        }
        stage ('Build Demo Night') {
            when {
                expression { params.Lane == 'Demo Night' }
            }
            steps {
                sh "export LANG=en_US.UTF-8 &amp;&amp; export FASTLANE_XCODE_LIST_TIMEOUT=120 &amp;&amp; export FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT=120 &amp;&amp; export FASTLANE_XCODEBUILD_SETTINGS_RETRIES=13 &amp;&amp; /usr/local/bin/fastlane demoNight"
            }
        }
    }
}
        </script>
        <sandbox>true</sandbox>
    </definition>
    <triggers/>
    <disabled>false</disabled>
</flow-definition>